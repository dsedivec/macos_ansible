- name: Clone Emacs Git repo
  git:
    repo: https://git.savannah.gnu.org/git/emacs.git
    dest: '{{ emacs_src_dir }}'
    # update=yes will "git reset --hard", which could lose local commits.
    # Also, if Emacs.app already exists, maybe it's annoying to rebuild Emacs
    # too frequently.
    update: '{{ software_emacs_update_git }}'
  register: git_clone_emacs

- name: Install Emacs dependencies
  macports:
    state: present
    selfupdate: true
    name:
      - autoconf
      - automake
      - librsvg
      - ImageMagick
      - jansson
      - gnutls
      - libxml2
      - ccache
      - texinfo
  become: true

- name: Check for Emacs.app installed
  stat:
    path: '{{ user_app_dir }}/Emacs.app'
  register: emacs_app_stat

- name: Build and install Emacs
  script: build_install_ns_port.sh
  args:
    chdir: '{{ emacs_src_dir }}'
  when: git_clone_emacs is changed or not emacs_app_stat.stat.exists

- name: Make bin directory
  file:
    state: directory
    path: '{{ user_bin_dir }}'

- name: Symlink emacsclient into bin directory
  file:
    state: link
    path: '{{ user_bin_dir }}/emacsclient'
    src: '{{ (user_app_dir + "/Emacs.app/Contents/MacOS/bin/emacsclient") | relpath(user_bin_dir) }}'
