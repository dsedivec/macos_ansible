- name: Clone change_modifiers repo
  git:
    repo: '{{ macos_prefs_change_modifiers_remote_repo }}'
    dest: '{{ macos_prefs_change_modifiers_local_repo }}'
    update: no

- name: Remap modifier keys
  command:
    argv:
      - python
      - '{{ macos_prefs_change_modifiers_local_repo }}/change_modifiers.py'
      - set
      - caps_lock,control
      - command,option
      - option,command
  register: change_modifiers
  changed_when: change_modifiers.stdout

- name: Clone Display Manager repo
  git:
    repo: '{{ macos_prefs_display_manager_remote_repo }}'
    dest: '{{ macos_prefs_display_manager_local_repo }}'
    update: no

- name: Get current resolution
  shell: /usr/bin/python '{{ macos_prefs_display_manager | quote }}'
         show current main | awk '/^resolution:/{print $2}'
  register: current_resolution
  changed_when: False

- name: Set resolution
  command:
    argv: [/usr/bin/python, '{{ macos_prefs_display_manager }}',
           res, '{{ macos_prefs_main_resolution|replace("x", " ") }}',
           0, only-hidpi, main]
  when: not ansible_check_mode
        and current_resolution.stdout.strip() != macos_prefs_main_resolution

- name: Set preferences
  x_osx_defaults:
    state: '{{ item.state | default("present") }}'
    host: '{{ item.host | default }}'
    domain: '{{ item.domain | default("NSGlobalDomain") }}'
    key: '{{ item.key }}'
    type: '{{ item.type | default }}'
    value: '{{ item.value | default }}'
  become: '{{ item.become | default(False) }}'
  loop: '{{ macos_prefs_set }}'

- name: Set power preferences
  pmset:
    type: charger
    name: sleep
    value: '0'
  become: yes
